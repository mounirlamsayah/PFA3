# ci_pipeline.yml

name: ML Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  ci_pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10.13
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.13'
    
    - name: Install requirements
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
  
    - name: Run data loader
      run: |
        python data_loader.py
        
    - name: Data preprocessing
      run: |
        python preprocessing.py
        
    - name: Feature extraction
      run: |
        python feature_extraction.py
        
    - name: Train model
      run: python train_model.py

    - name: Evaluate model
      run: python evaluate_model.py

    - name: Set up Ngrok and Run MLflow UI
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        pip install pyngrok requests
        python -c "
        import os
        import time
        import subprocess
        from pyngrok import ngrok

        ngrok.set_auth_token(os.environ['NGROK_AUTH_TOKEN'])

        mlflow_process = subprocess.Popen([
            'mlflow', 'ui',
            '--backend-store-uri', './mlruns',
            '--default-artifact-root', './mlruns',
            '--host', '0.0.0.0',
            '--port', '5000'
        ])
        time.sleep(10)
        print('Premier sleep terminÃ©')
        public_url = ngrok.connect(5000)
        print('\\n' + '='*50)
        print('ðŸš€ MLflow UI is available at:', public_url)
        print('='*50 + '\\n')
        time.sleep(1000)
        "

    # Correction des patterns de fichiers dans les artefacts
    - name: Archive model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          **/*.txt
          **/*.png
          **/*.csv
          **/*.keras
          **/*.h5
          **/*.pkl
          **/*.joblib
        retention-days: 30

    - name: Upload MLflow logs
      uses: actions/upload-artifact@v4
      with:
        name: mlruns
        path: mlruns/
        retention-days: 30

    - name: Upload Data directory
      uses: actions/upload-artifact@v4
      with:
        name: data
        path: data/
        retention-days: 30

    - name: Upload Outputs directory
      uses: actions/upload-artifact@v4
      with:
        name: outputs
        path: outputs/
        retention-days: 30

    # Ajout d'une vÃ©rification des artefacts crÃ©Ã©s
    - name: Verify artifacts existence
      run: |
        echo "=== Checking for model artifacts ==="
        find . -name "*.txt" -o -name "*.png" -o -name "*.csv" -o -name "*.keras" -o -name "*.h5" -o -name "*.pkl" -o -name "*.joblib" | head -20
        echo "=== Checking outputs directory ==="
        ls -la outputs/ || echo "Outputs directory not found"
        echo "=== Checking mlruns directory ==="
        ls -la mlruns/ || echo "MLruns directory not found"
        echo "=== Checking data directory ==="
        ls -la data/ || echo "Data directory not found"